<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pro Todo List</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; padding-top: 40px; margin: 0; padding-bottom: 40px; }
        .container { width: 100%; max-width: 420px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1f2937; margin-bottom: 1.5rem; font-weight: 800; }
        h3 { font-size: 1rem; color: #4b5563; margin: 20px 0 10px 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .badge { background-color: #e0e7ff; color: #4f46e5; font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; }

        /* Form Styles */
        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-size: 0.95rem; }
        button { background-color: #6366f1; color: white; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { background-color: #4f46e5; }

        /* Button Variants */
        .logout-btn { width: auto; padding: 4px 10px; font-size: 0.75rem; background-color: #9ca3af; }
        .delete-btn { width: auto; padding: 4px 8px; background: transparent; color: #ef4444; border: none; font-size: 1.1rem; cursor: pointer; margin-right: 5px; }
        .link-btn { background: none; color: #6366f1; border: none; cursor: pointer; font-size: 0.9rem; text-decoration: underline; display: inline; width: auto; padding: 0; margin: 0; }

        /* Utilities */
        .hidden { display: none !important; }
        .error-msg { color: #ef4444; font-size: 0.85rem; text-align: center; margin-bottom: 1rem; }

        /* Task Item */
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #f3f4f6; transition: 0.2s; }
        .task-item:hover { background-color: #f9fafb; }
        .task-item.completed .task-title { text-decoration: line-through; color: #9ca3af; }

        .task-content { display: flex; flex-direction: column; gap: 2px; }
        .task-title { font-weight: 500; color: #1f2937; }
        .task-meta { font-size: 0.75rem; color: #6b7280; display: flex; align-items: center; gap: 5px; }

        /* Tags */
        .tag { padding: 2px 6px; border-radius: 4px; font-weight: 600; background-color: #f3f4f6; color: #6b7280; }
        .tag.d-day { background-color: #fee2e2; color: #ef4444; }
        .tag.future { background-color: #ecfccb; color: #4d7c0f; }
        .tag.recurring { background-color: #dbeafe; color: #2563eb; }

        .task-controls { display: flex; align-items: center; }
        .checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #6366f1; margin: 0; }

        /* Input Group */
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-row select, .input-row input { margin-bottom: 0; }
    </style>
</head>
<body>

<div class="container" id="login-section">
    <h2>ğŸ” ë¡œê·¸ì¸</h2>
    <input type="email" id="login-email" placeholder="ì´ë©”ì¼" value="newuser@test.com">
    <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="1234">
    <div id="login-error" class="error-msg"></div>
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <div style="text-align: center; margin-top: 10px;">
        <span class="link-btn" onclick="toggleAuthMode('signup')">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</span>
    </div>
</div>

<div class="container hidden" id="signup-section">
    <h2>âœ¨ íšŒì›ê°€ì…</h2>
    <input type="email" id="signup-email" placeholder="ì´ë©”ì¼ (ì˜ˆ: user@test.com)">
    <input type="password" id="signup-password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <input type="text" id="signup-nickname" placeholder="ë‹‰ë„¤ì„">
    <div id="signup-error" class="error-msg"></div>
    <button onclick="signup()">ê°€ì…í•˜ê¸°</button>
    <div style="text-align: center; margin-top: 10px;">
        <span class="link-btn" onclick="toggleAuthMode('login')">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸</span>
    </div>
</div>

<div class="container hidden" id="app-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2 style="margin: 0;">My Tasks</h2>
        <button onclick="logout()" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <input type="text" id="task-title" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”..." style="background: white; margin-bottom: 10px;">

        <div class="input-row">
            <select id="recurrence-type" onchange="updateInputUI()" style="flex: 1.2;">
                <option value="ONE_TIME">ğŸ“… ë‚ ì§œ ì§€ì •</option>
                <option value="DAILY">ğŸ”„ ë§¤ì¼ ë°˜ë³µ</option>
                <option value="EVERY_N_DAYS">ğŸ”¢ Nì¼ ê°„ê²©</option>
                <option value="MONTHLY">ğŸ—“ ë§¤ì›” ë°˜ë³µ</option>
            </select>

            <input type="date" id="date-input" class="hidden" style="flex: 1.5;">
            <input type="number" id="number-input" class="hidden" placeholder="ê°’" min="1" max="31" style="flex: 0.8;">

            <button onclick="addTask()" style="width: 60px; margin-bottom: 0;">ì¶”ê°€</button>
        </div>
        <div id="input-hint" style="font-size: 0.8rem; color: #666; margin-top: 5px; text-align: right;"></div>
    </div>

    <h3>ğŸ”¥ ì˜¤ëŠ˜ í•  ì¼ <span id="today-count" class="badge">0</span></h3>
    <div id="today-list"></div>

    <h3>ğŸš€ ë‹¤ê°€ì˜¤ëŠ” ì¼ì • <span id="upcoming-count" class="badge">0</span></h3>
    <div id="upcoming-list"></div>
</div>

<script>
    // âœ… API ê²½ë¡œ ìƒìˆ˜
    const AUTH_API = '/api/auth';
    const TASK_API = '/todo/tasks';

    let token = localStorage.getItem('accessToken');

    // ì´ˆê¸° ì‹¤í–‰
    if (token) {
        showApp();
    } else {
        document.getElementById('date-input').valueAsDate = new Date();
        updateInputUI();
    }

    // --- í™”ë©´ ì œì–´ ---
    function toggleAuthMode(mode) {
        const loginSec = document.getElementById('login-section');
        const signupSec = document.getElementById('signup-section');
        document.getElementById('login-error').innerText = '';
        document.getElementById('signup-error').innerText = '';

        if (mode === 'signup') {
            loginSec.classList.add('hidden');
            signupSec.classList.remove('hidden');
        } else {
            signupSec.classList.add('hidden');
            loginSec.classList.remove('hidden');
        }
    }

    function updateInputUI() {
        const type = document.getElementById('recurrence-type').value;
        const dateInput = document.getElementById('date-input');
        const numberInput = document.getElementById('number-input');
        const hint = document.getElementById('input-hint');

        dateInput.classList.add('hidden');
        numberInput.classList.add('hidden');
        hint.innerText = "";

        if (type === 'ONE_TIME') {
            dateInput.classList.remove('hidden');
            if(!dateInput.value) dateInput.valueAsDate = new Date();
        } else if (type === 'EVERY_N_DAYS') {
            numberInput.classList.remove('hidden');
            numberInput.placeholder = "ê°„ê²© (ì¼)";
            hint.innerText = "ì˜ˆ: 3 ì…ë ¥ ì‹œ 3ì¼ë§ˆë‹¤ ë°˜ë³µ";
        } else if (type === 'MONTHLY') {
            numberInput.classList.remove('hidden');
            numberInput.placeholder = "ì¼ (1~31)";
            numberInput.value = new Date().getDate();
            hint.innerText = "ë§¤ì›” í•´ë‹¹ ë‚ ì§œì— ë°˜ë³µ";
        } else if (type === 'DAILY') {
            hint.innerText = "ë§¤ì¼ë§¤ì¼ ë°˜ë³µë©ë‹ˆë‹¤";
        }
    }

    // --- Auth ---
    async function signup() {
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const nickname = document.getElementById('signup-nickname').value;

        try {
            const res = await fetch(`${AUTH_API}/signup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, nickname })
            });

            // ë°±ì—”ë“œ ë¦¬íŒ©í† ë§ìœ¼ë¡œ ApiResponseê°€ ì˜´. res.okê°€ trueë©´ ì„±ê³µ.
            if (res.ok) {
                alert("ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
                toggleAuthMode('login');
                document.getElementById('login-email').value = email;
            } else {
                // ì‹¤íŒ¨ ì‹œ message êº¼ë‚´ê¸°
                const json = await res.json();
                document.getElementById('signup-error').innerText = json.message || "ê°€ì… ì‹¤íŒ¨";
            }
        } catch (e) {
            document.getElementById('signup-error').innerText = "ì„œë²„ ì—°ê²° ì˜¤ë¥˜";
        }
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
            const res = await fetch(`${AUTH_API}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const json = await res.json(); // ApiResponse ê°ì²´ ë°›ê¸°

            if (!res.ok) {
                throw new Error(json.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
            }

            // âœ… [ìˆ˜ì •] ApiResponse êµ¬ì¡°: json.data.accessToken
            token = json.data.accessToken;
            localStorage.setItem('accessToken', token);
            showApp();
        } catch (e) {
            document.getElementById('login-error').innerText = e.message;
        }
    }

    function logout() {
        localStorage.removeItem('accessToken');
        location.reload();
    }

    function showApp() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('signup-section').classList.add('hidden');
        document.getElementById('app-section').classList.remove('hidden');
        updateInputUI();
        loadTasks();
    }

    // --- Task ---
    async function loadTasks() {
        const res = await fetch(`${TASK_API}/today`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 403 || res.status === 401) { logout(); return; }

        const response = await res.json(); // ApiResponse
        // âœ… [ìˆ˜ì •] ì‹¤ì œ ë°ì´í„°ëŠ” response.data ì•ˆì— ìˆìŒ
        const data = response.data;

        renderList('today-list', data.today, true);
        document.getElementById('today-count').innerText = data.today.length;

        renderList('upcoming-list', data.upcoming, false);
        document.getElementById('upcoming-count').innerText = data.upcoming.length;
    }

    function renderList(elementId, tasks, isToday) {
        const list = document.getElementById(elementId);
        list.innerHTML = '';

        if (!tasks || tasks.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:15px; font-size:0.9rem;">ì—†ìŒ</div>';
            return;
        }

        tasks.forEach(task => {
            const div = document.createElement('div');
            div.className = `task-item ${task.completed ? 'completed' : ''}`;

            let metaHtml = '';
            if (task.taskType === 'RECURRING') {
                let ruleText = "ë°˜ë³µ";
                if (task.recurrenceRule === 'DAILY') ruleText = "ë§¤ì¼";
                else if (task.recurrenceRule.startsWith('EVERY_N_DAYS')) ruleText = `${task.recurrenceRule.split(':')[1]}ì¼ ê°„ê²©`;
                else if (task.recurrenceRule.startsWith('MONTHLY')) ruleText = `ë§¤ì›” ${task.recurrenceRule.split(':')[1]}ì¼`;
                metaHtml = `<span class="tag recurring">ğŸ”„ ${ruleText}</span>`;
            } else {
                const dateClass = isToday ? 'tag d-day' : 'tag future';
                const dateText = isToday ? 'ì˜¤ëŠ˜ ë§ˆê°' : `${task.dueDate} ê¹Œì§€`;
                metaHtml = `<span class="${dateClass}">${dateText}</span>`;
            }

            div.innerHTML = `
                <div class="task-content">
                    <span class="task-title">${task.title}</span>
                    <div class="task-meta">${metaHtml}</div>
                </div>
                <div class="task-controls">
                    <button class="delete-btn" onclick="deleteTask(${task.id})">âŒ</button>

                    ${isToday ? `
                    <input type="checkbox" class="checkbox"
                        ${task.completed ? 'checked' : ''}
                        onchange="toggleTask(${task.id}, this.checked)">
                    ` : ''}
                </div>
            `;
            list.appendChild(div);
        });
    }

    async function addTask() {
        const title = document.getElementById('task-title').value;
        const typeSelection = document.getElementById('recurrence-type').value;
        const dateVal = document.getElementById('date-input').value;
        const numberVal = document.getElementById('number-input').value;

        if (!title) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

        let taskType = "ONE_TIME";
        let dueDate = null;
        let recurrenceRule = null;

        if (typeSelection === 'ONE_TIME') {
            if (!dateVal) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”");
            taskType = "ONE_TIME";
            dueDate = dateVal;
        } else {
            taskType = "RECURRING";
            if (typeSelection === 'DAILY') {
                recurrenceRule = "DAILY";
            } else if (typeSelection === 'EVERY_N_DAYS') {
                if (!numberVal) return alert("ê°„ê²©ì„ ì…ë ¥í•˜ì„¸ìš”");
                recurrenceRule = `EVERY_N_DAYS:${numberVal}`;
            } else if (typeSelection === 'MONTHLY') {
                if (!numberVal || numberVal < 1 || numberVal > 31) return alert("ë‚ ì§œ(1~31)ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                recurrenceRule = `MONTHLY:${numberVal}`;
            }
        }

        const res = await fetch(TASK_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ title, taskType, dueDate, recurrenceRule })
        });

        if (res.ok) {
            document.getElementById('task-title').value = '';
            loadTasks();
        } else {
            const json = await res.json();
            alert(json.message || "ì¶”ê°€ ì‹¤íŒ¨");
        }
    }

    async function toggleTask(taskId, isChecked) {
        const method = isChecked ? 'POST' : 'DELETE';
        await fetch(`${TASK_API}/${taskId}/complete`, {
            method: method,
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadTasks();
    }

    async function deleteTask(taskId) {
        if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        await fetch(`${TASK_API}/${taskId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadTasks();
    }
</script>

</body>
</html>