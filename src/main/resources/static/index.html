<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Simple Todo App</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; padding-top: 50px; }
        .container { width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }

        /* ë©”ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { background-color: #5c67f2; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background-color: #4a54e1; }

        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (íšŒìƒ‰) */
        .logout-btn { width: auto; padding: 5px 10px; font-size: 0.8em; background-color: #888; margin-bottom: 0; }
        .logout-btn:hover { background-color: #666; }

        /* í•  ì¼ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; transition: 0.2s; }
        .task-item:hover { background-color: #fafafa; }
        .task-item.completed span { text-decoration: line-through; color: #888; }

        /* ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë¹¨ê°„ìƒ‰ X) */
        .delete-btn { width: auto; padding: 5px 8px; background-color: transparent; color: #ff4d4d; border: 1px solid transparent; margin-right: 5px; margin-bottom: 0; font-size: 0.9em; }
        .delete-btn:hover { background-color: #fff0f0; border-color: #ffcccc; color: #ff0000; }

        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .checkbox { width: auto; margin: 0; cursor: pointer; accent-color: #5c67f2; transform: scale(1.2); }

        .hidden { display: none; }
        #error-msg { color: red; font-size: 0.9em; text-align: center; margin-bottom: 10px; }

        /* ìš°ì¸¡ ì»¨íŠ¸ë¡¤ ì˜ì—­ (ì‚­ì œë²„íŠ¼ + ì²´í¬ë°•ìŠ¤) */
        .task-controls { display: flex; align-items: center; }
    </style>
</head>
<body>

<div class="container" id="login-section">
    <h2>ğŸ” ë¡œê·¸ì¸</h2>
    <input type="email" id="email" placeholder="ì´ë©”ì¼ (ì˜ˆ: newuser@test.com)" value="newuser@test.com">
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="1234">
    <div id="error-msg"></div>
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <p style="text-align: center; font-size: 0.8em;">(íšŒì›ê°€ì…ì€ Swaggerì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”)</p>
</div>

<div class="container hidden" id="app-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">ğŸ“ ì˜¤ëŠ˜ì˜ í•  ì¼</h2>
        <button onclick="logout()" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div style="border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px;">
        <input type="text" id="task-title" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”...">
        <div style="display: flex; gap: 5px;">
            <select id="task-type" style="margin-bottom: 0;">
                <option value="RECURRING">ğŸ” ë§¤ì¼ ë°˜ë³µ (Daily)</option>
                <option value="ONE_TIME">ğŸ“… ì˜¤ëŠ˜ í•œ ë²ˆë§Œ (One Time)</option>
            </select>
            <button onclick="addTask()" style="width: 80px; margin-bottom: 0;">ì¶”ê°€</button>
        </div>
    </div>

    <div id="task-list">
    </div>
</div>

<script>
    const API_BASE = '/api'; // ë¡œê·¸ì¸ì€ ì—¬ì „íˆ /api/auth ë¼ê³  ê°€ì •
    let token = localStorage.getItem('accessToken');

    if (token) {
        showApp();
    }

    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            // ë¡œê·¸ì¸ì€ ê¸°ì¡´ API ê²½ë¡œ ìœ ì§€
            const res = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (!res.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');

            const data = await res.json();
            token = data.accessToken;
            localStorage.setItem('accessToken', token);
            showApp();
        } catch (e) {
            document.getElementById('error-msg').innerText = "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        }
    }

    function logout() {
        localStorage.removeItem('accessToken');
        location.reload();
    }

    function showApp() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('app-section').classList.remove('hidden');
        loadTasks();
    }

    async function loadTasks() {
        // âœ… ìˆ˜ì •: ê²½ë¡œë¥¼ todo/tasks/today ë¡œ ë³€ê²½
        const res = await fetch(`todo/tasks/today`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.status === 403 || res.status === 401) { logout(); return; }

        const tasks = await res.json();
        const list = document.getElementById('task-list');
        list.innerHTML = '';

        if (tasks.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#888; padding:20px;">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        tasks.forEach(task => {
            const div = document.createElement('div');
            div.className = `task-item ${task.completed ? 'completed' : ''}`;

            div.innerHTML = `
                <span>
                    ${task.recurrenceRule === 'DAILY' ? 'ğŸ”' : 'ğŸ“…'}
                    ${task.title}
                </span>
                <div class="task-controls">
                    <button class="delete-btn" onclick="deleteTask(${task.id})" title="ì‚­ì œ">âŒ</button>
                    <input type="checkbox" class="checkbox"
                        ${task.completed ? 'checked' : ''}
                        onchange="toggleTask(${task.id}, this.checked)">
                </div>
            `;
            list.appendChild(div);
        });
    }

    async function addTask() {
        const title = document.getElementById('task-title').value;
        const type = document.getElementById('task-type').value;

        if (!title) return alert("í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”!");

        const body = {
            title: title,
            taskType: type,
            dueDate: type === 'ONE_TIME' ? new Date().toISOString().split('T')[0] : null,
            recurrenceRule: type === 'RECURRING' ? 'DAILY' : null
        };

        // âœ… ìˆ˜ì •: ê²½ë¡œë¥¼ todo/tasks ë¡œ ë³€ê²½
        const res = await fetch(`todo/tasks`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            document.getElementById('task-title').value = '';
            loadTasks();
        } else {
            alert("í•  ì¼ ì¶”ê°€ ì‹¤íŒ¨!");
        }
    }

    async function toggleTask(taskId, isChecked) {
        const method = isChecked ? 'POST' : 'DELETE';

        // âœ… ìˆ˜ì •: ê²½ë¡œë¥¼ todo/tasks/... ë¡œ ë³€ê²½
        const res = await fetch(`todo/tasks/${taskId}/complete`, {
            method: method,
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
            alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨!");
        }

        loadTasks();
    }

    async function deleteTask(taskId) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        // âœ… ìˆ˜ì •: ê²½ë¡œë¥¼ todo/tasks/... ë¡œ ë³€ê²½
        const res = await fetch(`todo/tasks/${taskId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
            loadTasks();
        } else {
            alert("ì‚­ì œ ì‹¤íŒ¨!");
        }
    }
</script>

</body>
</html>