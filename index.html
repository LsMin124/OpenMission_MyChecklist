<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Simple Todo App</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; padding-top: 50px; }
        .container { width: 400px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        input, select, button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #5c67f2; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #4a54e1; }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .task-item.completed span { text-decoration: line-through; color: #888; }
        .hidden { display: none; }
        #error-msg { color: red; font-size: 0.9em; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container" id="login-section">
    <h2>ğŸ” ë¡œê·¸ì¸</h2>
    <input type="email" id="email" placeholder="ì´ë©”ì¼ (ì˜ˆ: newuser@test.com)" value="newuser@test.com">
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="1234">
    <div id="error-msg"></div>
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <p style="text-align: center; font-size: 0.8em;">(íšŒì›ê°€ì…ì€ Swaggerì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”)</p>
</div>

<div class="container hidden" id="app-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>ğŸ“ ì˜¤ëŠ˜ì˜ í•  ì¼</h2>
        <button onclick="logout()" style="width: auto; padding: 5px 10px; font-size: 0.8em; background-color: #888;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div style="border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px;">
        <input type="text" id="task-title" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”...">
        <select id="task-type">
            <option value="ONE_TIME">ì˜¤ëŠ˜ í•œ ë²ˆë§Œ (One Time)</option>
            <option value="RECURRING">ë§¤ì¼ ë°˜ë³µ (Daily)</option>
        </select>
        <button onclick="addTask()">ì¶”ê°€í•˜ê¸°</button>
    </div>

    <div id="task-list">
    </div>
</div>

<script>
    const API_BASE = '/api';
    let token = localStorage.getItem('accessToken');

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
    if (token) {
        showApp();
    }

    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const res = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (!res.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');

            const data = await res.json();
            token = data.accessToken;
            localStorage.setItem('accessToken', token);
            showApp();
        } catch (e) {
            document.getElementById('error-msg').innerText = "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        }
    }

    function logout() {
        localStorage.removeItem('accessToken');
        location.reload();
    }

    function showApp() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('app-section').classList.remove('hidden');
        loadTasks();
    }

    async function loadTasks() {
        const res = await fetch(`todo/tasks/today`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

       if (res.status === 403) { logout(); return; } // í† í° ë§Œë£Œ ì‹œ ë¡œê·¸ì•„ì›ƒ

        const tasks = await res.json();
        const list = document.getElementById('task-list');
        list.innerHTML = '';

        tasks.forEach(task => {
            const div = document.createElement('div');
            div.className = `task-item ${task.completed ? 'completed' : ''}`;
            div.innerHTML = `
                <span>
                    ${task.recurrenceRule === 'DAILY' ? 'ğŸ”' : 'ğŸ“…'}
                    ${task.title}
                </span>
                <input type="checkbox"
                    ${task.completed ? 'checked disabled' : ''}
                    onchange="completeTask(${task.id})">
            `;
            list.appendChild(div);
        });
    }

    async function addTask() {
        const title = document.getElementById('task-title').value;
        const type = document.getElementById('task-type').value;

        if (!title) return alert("í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”!");

        const body = {
            title: title,
            taskType: type,
            // ONE_TIMEì´ë©´ ì˜¤ëŠ˜ ë‚ ì§œ, RECURRINGì´ë©´ DAILY ì„¤ì •
            dueDate: type === 'ONE_TIME' ? new Date().toISOString().split('T')[0] : null,
            recurrenceRule: type === 'RECURRING' ? 'DAILY' : null
        };

        await fetch(`todo/tasks`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
        });

        document.getElementById('task-title').value = '';
        loadTasks();
    }

    async function completeTask(taskId) {
        if (!confirm("ì™„ë£Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            loadTasks(); // ì·¨ì†Œ ì‹œ ì²´í¬ë°•ìŠ¤ ì›ìƒë³µêµ¬
            return;
        }

        await fetch(`todo/tasks/${taskId}/complete`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        loadTasks();
    }
</script>

</body>
</html>